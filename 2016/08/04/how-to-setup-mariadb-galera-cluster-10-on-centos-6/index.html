<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HowTo Setup MariaDB Galera Cluster 10 On CentOS 6.x · SAMZONG</title><meta name="description" content="HowTo Setup MariaDB Galera Cluster 10 On CentOS 6.x - SAMZONG"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://samzong.me/atom.xml" title="SAMZONG"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HowTo Setup MariaDB Galera Cluster 10 On CentOS 6.x</h1><div class="post-info">Aug 4, 2016</div><div class="post-content"><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MariaDB Galera Cluster 是一套在MySQL InnoDB存储引擎上面实现multi-master及数据实时同步的系统架构，业务层面无需做读写分离工作，数据库读写压力都能按照既定的规则分发到 各个节点上去。在数据方面完全兼容 MariaDB 和 MySQL。使用MariaDB Galera的解决方案，可以方便快速的搭建出高可用的数据库Cluster，不是主备模式，而是双活模式，也就是说，没有主节点和备份节点，每个节点都可以看做是主节点，都可以进行读写，由Galera来实现底层的数据同步。<br></p>

<ul>
<li>真正的多主架构，任何节点都可以进行读写</li>
<li>同步复制，各节点间无延迟且节点宕机不会导致数据丢失</li>
<li>紧密耦合，所有节点均保持相同状态</li>
<li>自动节点配置，无需手工备份当前数据库并拷贝至新节点</li>
</ul>
<h4 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h4><ul>
<li>Cluster node4 IP address 172.16.102.168</li>
<li>Cluster node5 IP address 172.16.102.165</li>
<li>Cluster node6 IP address 172.16.102.164</li>
<li>setenforce 0；sed -i ‘s/SELINUX=enforcing/SELINUX=disabled/‘ /etc/selinux/config</li>
<li>/etc/init.d/iptables stop;chkconfig iptables off</li>
</ul>
<blockquote>
<p>使用vmware 测试需注意:克隆机器需要删除 <code>/etc/udev/rules.d/70-persistent-net.rules</code> 以及<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code>中的网卡mac地址选项，不然网卡起不来</p>
</blockquote>
<h4 id="环境检测"><a href="#环境检测" class="headerlink" title="环境检测"></a>环境检测</h4><ul>
<li>检查iptables状态：/etc/init.d/iptables status;chkconfig –list | grep iptables</li>
<li>检查selinux状态：getenforce</li>
<li>检查openssh-client包是否安装：系统中是否有ssh命令</li>
<li>检查是否系统中含有mysql相关的包：rpm -qa | grep mysql，有的话都需要卸载掉</li>
<li>检查网络是否通畅：ping www.baidu.com</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="1-在所有节点编辑-etc-hosts"><a href="#1-在所有节点编辑-etc-hosts" class="headerlink" title="1. 在所有节点编辑/etc/hosts"></a>1. 在所有节点编辑/etc/hosts</h5><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@node4 ~]# vi /etc/hosts</div><div class="line"></div><div class="line"><span class="number">127.0</span><span class="meta">.0</span><span class="meta">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</div><div class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</div><div class="line"></div><div class="line"># <span class="keyword">add</span> follows</div><div class="line"><span class="number">172.16</span><span class="meta">.102</span><span class="meta">.164</span> node6</div><div class="line"><span class="number">172.16</span><span class="meta">.102</span><span class="meta">.165</span> node5</div><div class="line"><span class="number">172.16</span><span class="meta">.102</span><span class="meta">.168</span> node4</div><div class="line"></div><div class="line">[root@node4 ~]#</div><div class="line"></div><div class="line"># 依次在node5和node6上编辑/etc/hosts</div></pre></td></tr></table></figure>
<h5 id="2-在所有node上安装-MariaDB-Galera"><a href="#2-在所有node上安装-MariaDB-Galera" class="headerlink" title="2. 在所有node上安装 MariaDB Galera"></a>2. 在所有node上安装 MariaDB Galera</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="section">[root@node4 ~]</span><span class="comment"># vi /etc/yum.repos.d/mariadb.repo</span></div><div class="line"> <span class="comment"># MariaDB 10.0 CentOS repository list</span></div><div class="line"><span class="comment"># http://mariadb.org/mariadb/repositories/</span></div><div class="line"><span class="section">[mariadb]</span></div><div class="line"><span class="attr">name</span> = MariaDB</div><div class="line"><span class="attr">baseurl</span> = http://yum.mariadb.org/<span class="number">10.0</span>/centos6-amd64</div><div class="line"><span class="attr">gpgkey</span>=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</div><div class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></div><div class="line"><span class="attr">enabled</span>=<span class="number">0</span></div><div class="line"><span class="section"></span></div><div class="line">[root@node4 ~]<span class="comment"># yum --enablerepo=mariadb -y install MariaDB-Galera-server</span></div><div class="line"></div><div class="line"><span class="comment"># 依次在node5和node6上安装 MariaDB-Galera-server</span></div></pre></td></tr></table></figure>
<blockquote>
<p><i>注意安装完成之后，不要启动mysql</i></p>
</blockquote>
<h5 id="3-在其中一个节点上编辑-etc-my-cnf-d-server-cnf配置文件"><a href="#3-在其中一个节点上编辑-etc-my-cnf-d-server-cnf配置文件" class="headerlink" title="3. 在其中一个节点上编辑/etc/my.cnf.d/server.cnf配置文件"></a>3. 在其中一个节点上编辑/etc/my.cnf.d/server.cnf配置文件</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@node4 ~]<span class="comment"># vi /etc/my.cnf.d/server.cnf</span></div><div class="line"><span class="comment"># 19 行，取消下面的注释，并修改为需求</span></div><div class="line">[galera]</div><div class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</div><div class="line"><span class="comment"># 指定节点地址，这里也可以使用ip,如果没做安装1，可以直接把cluster的ip写在这里。</span></div><div class="line">wsrep_cluster_address=<span class="string">"gcomm://node4,node5,node6"</span></div><div class="line">binlog_format=row</div><div class="line">default_storage_engine=InnoDB</div><div class="line">innodb_autoinc_lock_mode=2</div><div class="line">bind-address=0.0.0.0</div><div class="line"></div><div class="line"><span class="comment"># add follows</span></div><div class="line"><span class="comment"># cluster name</span></div><div class="line">wsrep_cluster_name=<span class="string">"Visionet_MariaDB_Cluster"</span></div><div class="line"><span class="comment"># replication provider</span></div><div class="line">wsrep_sst_method=rsync</div><div class="line"><span class="comment"># own IP address</span></div><div class="line">wsrep_node_address=<span class="string">"172.16.102.168"</span></div><div class="line">wsrep_node_name=<span class="string">"node4"</span></div><div class="line"></div><div class="line"><span class="comment"># 启动数据库</span></div><div class="line">[root@node4 ~]<span class="comment"># /etc/rc.d/init.d/mysql bootstrap</span></div><div class="line">Starting MySQL. SUCCESS!</div><div class="line"></div><div class="line"><span class="comment"># 初始化你的数据库</span></div><div class="line">[root@node4 ~]<span class="comment"># mysql_secure_installation</span></div></pre></td></tr></table></figure>
<h5 id="4-在其它节点上编辑-etc-my-cnf-d-server-cnf配置文件"><a href="#4-在其它节点上编辑-etc-my-cnf-d-server-cnf配置文件" class="headerlink" title="4. 在其它节点上编辑/etc/my.cnf.d/server.cnf配置文件"></a>4. 在其它节点上编辑/etc/my.cnf.d/server.cnf配置文件</h5><h5 id="node5"><a href="#node5" class="headerlink" title="node5"></a>node5</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@node5 ~]<span class="comment"># vi /etc/my.cnf.d/server.cnf</span></div><div class="line"><span class="comment"># 19 行，取消下面的注释，并修改为需求</span></div><div class="line">[galera]</div><div class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</div><div class="line"><span class="comment"># 指定节点地址，这里也可以使用ip,如果没做安装1，可以直接把cluster的ip写在这里。</span></div><div class="line">wsrep_cluster_address=<span class="string">"gcomm://node4,node5,node6"</span></div><div class="line">binlog_format=row</div><div class="line">default_storage_engine=InnoDB</div><div class="line">innodb_autoinc_lock_mode=2</div><div class="line">bind-address=0.0.0.0</div><div class="line"></div><div class="line"><span class="comment"># add follows</span></div><div class="line"><span class="comment"># cluster name</span></div><div class="line">wsrep_cluster_name=<span class="string">"Visionet_MariaDB_Cluster"</span></div><div class="line"><span class="comment"># replication provider</span></div><div class="line">wsrep_sst_method=rsync</div><div class="line"></div><div class="line"><span class="comment"># 以下内容注意，注意应设置为当前服务器信息</span></div><div class="line">wsrep_node_address=<span class="string">"172.16.102.165"</span></div><div class="line">wsrep_node_name=<span class="string">"node5"</span></div><div class="line"></div><div class="line"><span class="comment"># 启动数据库</span></div><div class="line">[root@node5 ~]<span class="comment"># /etc/rc.d/init.d/mysql start</span></div><div class="line">Starting MySQL...SST in progress, setting sleep higher. SUCCESS!</div></pre></td></tr></table></figure>
<h5 id="node6"><a href="#node6" class="headerlink" title="node6"></a>node6</h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[root@node6 ~]<span class="comment"># vi /etc/my.cnf.d/server.cnf</span></div><div class="line"><span class="comment"># 19 行，取消下面的注释，并修改为需求</span></div><div class="line">[galera]</div><div class="line">wsrep_provider=/usr/lib64/galera/libgalera_smm.so</div><div class="line"><span class="comment"># 指定节点地址，这里也可以使用ip,如果没做安装1，可以直接把cluster的ip写在这里。</span></div><div class="line">wsrep_cluster_address=<span class="string">"gcomm://node4,node5,node6"</span></div><div class="line">binlog_format=row</div><div class="line">default_storage_engine=InnoDB</div><div class="line">innodb_autoinc_lock_mode=2</div><div class="line">bind-address=0.0.0.0</div><div class="line"></div><div class="line"><span class="comment"># add follows</span></div><div class="line"><span class="comment"># cluster name</span></div><div class="line">wsrep_cluster_name=<span class="string">"Visionet_MariaDB_Cluster"</span></div><div class="line"><span class="comment"># replication provider</span></div><div class="line">wsrep_sst_method=rsync</div><div class="line"></div><div class="line"><span class="comment"># 以下内容注意，注意应设置为当前服务器信息</span></div><div class="line">wsrep_node_address=<span class="string">"172.16.102.164"</span></div><div class="line">wsrep_node_name=<span class="string">"node6"</span></div><div class="line"></div><div class="line"><span class="comment"># 启动数据库</span></div><div class="line">[root@node6 ~]<span class="comment"># /etc/rc.d/init.d/mysql start</span></div><div class="line">Starting MySQL...SST in progress, setting sleep higher. SUCCESS!</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：只需要初始化第一个节点服务器的数据库，其他数据的配置文件会自动同步，所以你给node4设置的root可以在node5和node6直接使用，当然这是安装正确的前提。</p>
</blockquote>
<h4 id="登陆各个节点数据库检查配置是否成功"><a href="#登陆各个节点数据库检查配置是否成功" class="headerlink" title="登陆各个节点数据库检查配置是否成功"></a>登陆各个节点数据库检查配置是否成功</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server.cnf的配置如果没有问题，那么wsrep_local_state_comment的状态应该是Synced。<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@node4 ~]# mysql -u root -p</div><div class="line">Enter password:</div><div class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</div><div class="line">Your MariaDB connection id is 15</div><div class="line">Server version: 10.0.26-MariaDB-wsrep MariaDB Server, wsrep<span class="emphasis">_25.13.raf7f02e</span></div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</div><div class="line"></div><div class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; show status like <span class="emphasis">'wsrep_local_state_comment'</span>;</div><div class="line"><span class="code">+---------------------------+</span>--------+</div><div class="line"><span class="section">| Variable_name             | Value  |</span></div><div class="line">+---------------------------+--------+</div><div class="line"><span class="section">| wsrep_local_state_comment | Synced |</span></div><div class="line">+---------------------------+--------+</div><div class="line">1 row in set (0.01 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt;</div></pre></td></tr></table></figure></p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MariaDB Galera没有主节点和备份节点，配置成功之后，可以在任何一个node节点上操作会自动同步到其他节点，任何一个节点宕机不会影响其他节点的数据和稳定性，配置HAProxy设置VIP的方式来实现负载均衡，提高服务的高可用性，另外，当宕机节点上线之后，事务会自动同步不丢失。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/08/13/use-wdlinux-install-lnmp/" class="prev">PREV</a><a href="/2016/08/02/install-openfire/" class="next">NEXT</a></div><div class="copyright"><p>© 2012 - 2017 <a href="https://samzong.me">SAMZONG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>