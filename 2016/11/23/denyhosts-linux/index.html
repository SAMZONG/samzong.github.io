<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Denyhosts增加服务器SSH黑名单机制 · SAMZONG</title><meta name="description" content="Denyhosts增加服务器SSH黑名单机制 - SAMZONG"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://samzong.me/atom.xml" title="SAMZONG"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Denyhosts增加服务器SSH黑名单机制</h1><div class="post-info">Nov 23, 2016</div><div class="post-content"><h5 id="查看当前服务器失败登录的统计："><a href="#查看当前服务器失败登录的统计：" class="headerlink" title="查看当前服务器失败登录的统计："></a>查看当前服务器失败登录的统计：</h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">cat</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/secure | awk '/Failed/&#123;<span class="keyword">print</span> $(NF-3)&#125;' | <span class="keyword">sort</span> | uniq -c | <span class="keyword">sort</span> -<span class="keyword">n</span> |  awk '&#123;<span class="keyword">print</span> <span class="variable">$2</span><span class="string">" = "</span><span class="variable">$1&#125;</span>'</div></pre></td></tr></table></figure>
<h5 id="Install-denyhosts"><a href="#Install-denyhosts" class="headerlink" title="Install denyhosts"></a>Install denyhosts</h5><figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 需要预先安装epel源</span></div><div class="line">sudo yum <span class="keyword">install</span> -y epel-release</div><div class="line">sudo yum <span class="keyword">install</span> -y denyhosts</div></pre></td></tr></table></figure>
<h5 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a>配置文件解析</h5><p>默认配置文件/etc/denyhosts。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看的sshd日志文件</span></div><div class="line"><span class="attr">SECURE_LOG</span> = /var/log/secure</div><div class="line"></div><div class="line"><span class="comment"># 将阻止IP写入的配置文件</span></div><div class="line"><span class="attr">HOSTS_DENY</span> = /etc/hosts.deny</div><div class="line"></div><div class="line"><span class="comment"># 过多久之后清除，其中w代表周，d代表天，h代表小时，s代表秒，m代表分钟。</span></div><div class="line"><span class="attr">PURGE_DENY</span> = <span class="number">4</span>h</div><div class="line"></div><div class="line"><span class="comment"># 阻止的服务名称</span></div><div class="line"><span class="attr">BLOCK_SERVICE</span>  = sshd</div><div class="line"></div><div class="line"><span class="comment"># 允许无效用户（在/etc/passwd未列出）登录失败次数,允许无效用户登录失败的次数.</span></div><div class="line"><span class="attr">DENY_THRESHOLD_INVALID</span> = <span class="number">1</span></div><div class="line"></div><div class="line"><span class="comment"># 允许普通用户登录失败的次数</span></div><div class="line"><span class="attr">DENY_THRESHOLD_VALID</span> = <span class="number">5</span></div><div class="line"></div><div class="line"><span class="comment"># 允许root登录失败的次数</span></div><div class="line"><span class="attr">DENY_THRESHOLD_ROOT</span> = <span class="number">2</span></div><div class="line"><span class="attr">DENY_THRESHOLD_RESTRICTED</span> = <span class="number">1</span></div><div class="line"></div><div class="line"><span class="comment"># 设定 deny host 写入到该资料夹</span></div><div class="line"><span class="attr">WORK_DIR</span> = /var/lib/denyhosts</div><div class="line"></div><div class="line"><span class="comment"># 将deny的host或ip纪录到Work_dir中</span></div><div class="line"><span class="attr">SUSPICIOUS_LOGIN_REPORT_ALLOWED_HOSTS</span>=<span class="literal">YES</span></div><div class="line"></div><div class="line"><span class="comment"># 是否做域名反解</span></div><div class="line"><span class="attr">HOSTNAME_LOOKUP</span>=<span class="literal">YES</span></div><div class="line"></div><div class="line"><span class="comment"># 将DenyHOts启动的pid纪录到LOCK_FILE中，已确保服务正确启动，防止同时启动多个服务。</span></div><div class="line"><span class="attr">LOCK_FILE</span> = /var/lock/subsys/denyhosts</div><div class="line"></div><div class="line"><span class="comment"># 设置管理员邮件地址</span></div><div class="line"><span class="attr">ADMIN_EMAIL</span> = luchuanjia@msn.com</div><div class="line"><span class="attr">SMTP_HOST</span> = localhost</div><div class="line"><span class="attr">SMTP_PORT</span> = <span class="number">25</span></div><div class="line"><span class="attr">SMTP_FROM</span> = DenyHosts &lt;nobody@localhost&gt;</div><div class="line"><span class="attr">SMTP_SUBJECT</span> = DenyHosts Report from $[HOSTNAME]</div><div class="line"></div><div class="line"><span class="comment"># 有效用户登录失败计数归零的时间</span></div><div class="line"><span class="attr">AGE_RESET_VALID</span>=<span class="number">1</span>d</div><div class="line"></div><div class="line"><span class="comment"># root用户登录失败计数归零的时间</span></div><div class="line"><span class="attr">AGE_RESET_ROOT</span>=<span class="number">25</span>d</div><div class="line"></div><div class="line"><span class="comment"># 用户的失败登录计数重置为0的时间(/usr/share/denyhosts/data/restricted-usernames)</span></div><div class="line"><span class="attr">AGE_RESET_RESTRICTED</span>=<span class="number">25</span>d</div><div class="line"></div><div class="line"><span class="comment"># 无效用户登录失败计数归零的时间</span></div><div class="line"><span class="attr">AGE_RESET_INVALID</span>=<span class="number">10</span>d</div><div class="line"></div><div class="line"><span class="comment"># denyhosts的日志文件位置</span></div><div class="line"><span class="attr">DAEMON_LOG</span> = /var/log/denyhosts</div><div class="line"></div><div class="line"><span class="comment"># denyhosts的轮询时间</span></div><div class="line"><span class="attr">DAEMON_SLEEP</span> = <span class="number">30</span>s</div><div class="line"></div><div class="line"><span class="comment"># 该项与PURGE_DENY 设置一样，也是清除hosts.deny中 ssh用户的时间</span></div><div class="line"><span class="attr">DAEMON_PURGE</span> = <span class="number">1</span>h</div></pre></td></tr></table></figure></p>
<h5 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h5><ol>
<li>如果想删除一个已经禁止的主机IP，并加入到允许主机例表，只在 /etc/hosts.deny 删除是没用的,还需要以下：<figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/var/<span class="class"><span class="keyword">lib</span>/<span class="title">denyhosts</span> 目录，进入以下操作：</span></div><div class="line"><span class="comment"># 停止denyhosts服务</span></div><div class="line">sudo service denyhosts stop</div><div class="line"></div><div class="line"><span class="comment"># 进入denyhosts的目录</span></div><div class="line">cd /var/<span class="class"><span class="keyword">lib</span>/<span class="title">denyhosts</span></span></div><div class="line"></div><div class="line"><span class="comment"># 查看哪些文件添加了ssh限制,将IP_addr替换成你的IP</span></div><div class="line">sudo grep IP_addr /usr/share/denyhosts/data/*</div><div class="line"></div><div class="line"><span class="comment"># 然后一个个删除文件中你想取消的主机IP所在的行:</span></div><div class="line">/usr/share/denyhosts/data/hosts</div><div class="line">/usr/share/denyhosts/data/hosts-restricted</div><div class="line">/usr/share/denyhosts/data/hosts-root</div><div class="line">/usr/share/denyhosts/data/hosts-valid</div><div class="line">/usr/share/denyhosts/data/users-hosts</div><div class="line"></div><div class="line"><span class="comment"># 添加你想允许的主机IP地址到allowed-hosts:</span></div><div class="line">sudo echo IP_addr &gt;&gt;<span class="regexp">/usr/share</span><span class="regexp">/denyhosts/data</span><span class="regexp">/allowed-hostsps</span></div><div class="line"></div><div class="line"># 启动 DenyHosts服务：</div><div class="line"> service denyhosts start</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>尽量是用key验证登录服务器</li>
<li>尽量从固定IP点登录服务器，然后将该地址加入白名单</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2016/11/27/sdfwsdserbnssd/" class="prev">PREV</a><a href="/2016/11/18/ghostzeng-jia-ping-lun-mo-kuai/" class="next">NEXT</a></div><div class="copyright"><p>© 2012 - 2017 <a href="https://samzong.me">SAMZONG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>