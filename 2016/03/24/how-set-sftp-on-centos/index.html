<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 在CentOS中配置 SFTP 环境 · SAMZONG</title><meta name="description" content="在CentOS中配置 SFTP 环境 - SAMZONG"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://samzong.me/atom.xml" title="SAMZONG"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">在CentOS中配置 SFTP 环境</h1><div class="post-info">Mar 24, 2016</div><div class="post-content"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;做运维工作的，应该经常会碰到这样的问题，需要新上一个web项目，需要上传文件到服务器上，解决方法有很多种，常见的如sftp和ftp，今天讲如何使用sftp让系统用户用户上传项目的权限，并且实现chroot和无法使用ssh登录到系统。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SFTP是指SSH文件传输协议（SSH File Transfer protocol）或安全文件传输协议（Secure File Transfer Protocol），它提供了可信数据流下的文件访问、文件传输以及文件管理功能。当我们为SFTP配置chroot环境后，只有被许可的用户可以访问，并被限制到他们的家目录中，换言之：被许可的用户将处于牢笼环境中，在此环境中它们甚至不能切换它们的目录。</p>
<h3 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1. 测试环境"></a>1. 测试环境</h3><ul>
<li>MacBook Pro 15-inch i7 16GB</li>
<li>VMware Fushion 8 Pro</li>
<li>Transmit （ SFTP tools for Mac ）</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@test ~]<span class="comment"># cat /etc/issue</span></div><div class="line">CentOS release <span class="number">6.6</span> (Final)</div><div class="line">Kernel <span class="string">\r</span> <span class="literal">on</span> an <span class="string">\m</span></div><div class="line">[root@test ~]<span class="comment"># rpm -qa | grep openssh-server</span></div><div class="line">openssh-server-<span class="number">5.3p</span>1-<span class="number">104.el</span>6.i686</div></pre></td></tr></table></figure>
<h3 id="2-实验步骤"><a href="#2-实验步骤" class="headerlink" title="2. 实验步骤"></a>2. 实验步骤</h3><h5 id="2-1-增加一个sftpusers用户组"><a href="#2-1-增加一个sftpusers用户组" class="headerlink" title="2.1 增加一个sftpusers用户组"></a>2.1 增加一个sftpusers用户组</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># groupadd sftpusers</span></div></pre></td></tr></table></figure>
<h5 id="2-2-创建一个用户user01，并分配给sftpusers用户组"><a href="#2-2-创建一个用户user01，并分配给sftpusers用户组" class="headerlink" title="2.2 创建一个用户user01，并分配给sftpusers用户组"></a>2.2 创建一个用户user01，并分配给sftpusers用户组</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># useradd -g sftpusers user01</span></div></pre></td></tr></table></figure>
<h5 id="2-3-修改用户家目录及指定不能登录shell"><a href="#2-3-修改用户家目录及指定不能登录shell" class="headerlink" title="2.3 修改用户家目录及指定不能登录shell"></a>2.3 修改用户家目录及指定不能登录shell</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># mkdir /sftp/</span></div><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># usermod -s /sbin/nologin -d /sftp/user01 -m user01</span></div></pre></td></tr></table></figure>
<h5 id="2-4-给用户创建密码（注意密码不明文显示）"><a href="#2-4-给用户创建密码（注意密码不明文显示）" class="headerlink" title="2.4 给用户创建密码（注意密码不明文显示）"></a>2.4 给用户创建密码（注意密码不明文显示）</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@test ~]# passwd user01</div><div class="line">Changing password <span class="keyword">for</span><span class="built_in"> user </span>user01.</div><div class="line">New password:</div><div class="line">BAD PASSWORD: it is too simplistic/systematic</div><div class="line">BAD PASSWORD: is too<span class="built_in"> simple</span></div><div class="line">Retype new password:</div><div class="line">passwd: all authentication tokens updated successfully.</div><div class="line">[root@test ~]#</div></pre></td></tr></table></figure>
<h4 id="2-5-修改ssh的配置文件，如下设置"><a href="#2-5-修改ssh的配置文件，如下设置" class="headerlink" title="2.5 修改ssh的配置文件，如下设置"></a>2.5 修改ssh的配置文件，如下设置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@test ~]# ll /etc/ssh/sshd_config</div><div class="line">-rw-------. 1 root root 3879 Oct 15  2014 /etc/ssh/sshd_config</div><div class="line">[root@test ~]# vim /etc/ssh/sshd_config</div><div class="line"></div><div class="line"><span class="comment"># line 132</span></div><div class="line"><span class="comment">#Subsystem      sftp    /usr/libexec/openssh/sftp-server    #注释</span></div><div class="line">Subsystem       sftp    internal-sftp        #修改为internal-sftp</div><div class="line"></div><div class="line"><span class="comment"># add this lines at the end of file</span></div><div class="line">Match<span class="built_in"> Group </span>sftpusers        #指定一下参数仅适用的用户组sftpusers</div><div class="line">    X11Forwarding <span class="literal">no</span></div><div class="line">    AllowTcpForwarding <span class="literal">no</span></div><div class="line">    ChrootDirectory %h       #设置chroot将用户锁在家目录，%<span class="attribute">h</span>=家目录</div><div class="line">    ForceCommand internal-sftp    #该参数强制执行内部sftp</div></pre></td></tr></table></figure>
<h5 id="2-6-重启ssh服务"><a href="#2-6-重启ssh服务" class="headerlink" title="2.6 重启ssh服务"></a>2.6 重启ssh服务</h5><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">[root@test ~]</span># /etc/init.d/sshd restart</div><div class="line">Stopping sshd:                                             <span class="string">[  OK  ]</span></div><div class="line">Starting sshd:                                             <span class="string">[  OK  ]</span></div></pre></td></tr></table></figure>
<h5 id="2-7-设置用户家目录权限-注意权限不能大于0755"><a href="#2-7-设置用户家目录权限-注意权限不能大于0755" class="headerlink" title="2.7 设置用户家目录权限,(注意权限不能大于0755)"></a>2.7 设置用户家目录权限,(注意权限不能大于0755)</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># chmod 0755 /sftp/user01/</span></div><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># chown root /sftp/user01/</span></div><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># chgrp -R sftpusers /sftp/user01/</span></div></pre></td></tr></table></figure>
<h5 id="2-8-关于上传-根目录无法上传文件。"><a href="#2-8-关于上传-根目录无法上传文件。" class="headerlink" title="2.8 关于上传,根目录无法上传文件。"></a>2.8 关于上传,根目录无法上传文件。</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;因为用户家目录属主是root，并且权限最大0755，所以没法写，我的解决方法是在在家目录建立一个文件夹，作为上传目录，并把属主给user01即可。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># mkdir /sftp/user01/upload</span></div><div class="line">[root<span class="symbol">@test</span> ~]<span class="meta"># chown user01:sftpusers /sftp/user01/upload/</span></div></pre></td></tr></table></figure>
<h3 id="3-测试验证"><a href="#3-测试验证" class="headerlink" title="3. 测试验证"></a>3. 测试验证</h3><h5 id="3-1-Linux-登录测试"><a href="#3-1-Linux-登录测试" class="headerlink" title="3.1 Linux 登录测试"></a>3.1 Linux 登录测试</h5><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@test ~]<span class="comment"># su - user01</span></div><div class="line">This account is currently <span class="keyword">not</span> available.    <span class="comment">#su - 切换失败</span></div><div class="line"></div><div class="line">[root@test ~]<span class="comment"># cat /etc/passwd | tail -1</span></div><div class="line"><span class="symbol">user01:</span><span class="symbol">x:</span><span class="number">500</span><span class="symbol">:</span><span class="number">500</span><span class="symbol">:</span><span class="symbol">:/sftp/user01</span><span class="symbol">:/sbin/nologin</span></div><div class="line"></div><div class="line">[root@test ~]<span class="comment"># ssh user01<span class="doctag">@localhost</span></span></div><div class="line">The authenticity of host <span class="string">'localhost (::1)'</span> can<span class="string">'t be established.</span></div><div class="line">RSA key fingerprint is f3:fc:31:dc:7d:16:d5:ad:8c:bc:eb:69:8f:b2:0b:c9.</div><div class="line">Are you sure you want to continue connecting (yes/no)? yes</div><div class="line">Warning: Permanently added 'localhost<span class="string">' (RSA) to the list of known hosts.</span></div><div class="line">user01@localhost's <span class="symbol">password:</span></div><div class="line">This service allows sftp connections only.    <span class="comment">#ssh登录也失败，ssh设置成功</span></div><div class="line">Connection to localhost closed.</div><div class="line"></div><div class="line">[root@test ~]<span class="comment"># sftp user01<span class="doctag">@localhost</span></span></div><div class="line">Connecting to localhost...</div><div class="line">user01@localhost<span class="string">'s password:</span></div><div class="line">sftp&gt; ls</div><div class="line">upload</div><div class="line">sftp&gt; pwd</div><div class="line">Remote working directory: /</div><div class="line">sftp&gt;</div></pre></td></tr></table></figure>
<h5 id="3-2-SFTP-工具测试"><a href="#3-2-SFTP-工具测试" class="headerlink" title="3.2 SFTP 工具测试"></a>3.2 SFTP 工具测试</h5><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我这里使用的是Mac，但是传统的文件传输工具都差不多，Windows下有Winscp、Xftp等。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/27/mongodb01/" class="prev">PREV</a><a href="/2016/03/24/crontab-sync-sendmail/" class="next">NEXT</a></div><div class="copyright"><p>© 2012 - 2017 <a href="https://samzong.me">SAMZONG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>