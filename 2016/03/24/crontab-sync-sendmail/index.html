<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> MySQL(6) 利用Linux计划任务定时同步MySQL · SAMZONG</title><meta name="description" content="MySQL(6) 利用Linux计划任务定时同步MySQL - SAMZONG"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://samzong.me/atom.xml" title="SAMZONG"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">MySQL(6) 利用Linux计划任务定时同步MySQL</h1><div class="post-info">Mar 24, 2016</div><div class="post-content"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 说下实际项目场景，公司一个应用已部署主从数据库，业务也正式上线；现在客户公司领导希望可以看到每天的业务数据报表，本设定直接到从库拿数据，然后进行数据处理，生成报表，但是Java同事提出需求新增用户和权限表，这样一来，如果直接使用生产库的表会导致后台系统管理人员与领导的账户和权限混淆，经过讨论决定，按照生产库的表结构新增特殊用户表和权限表；这样操作实际是可以在从库上新增表单，且不影响主从库之间的数据同步，但是从安全性的考虑，新增表单设计需要给用户Insert权限，为了保证从库只有利用主库同步写入数据，则只能给其他用户select权限。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>最终决定，因为报表系统的使用率低，直接在报表系统的服务器安装本地mysql数据库，通过计划任务定时到从库上同步数据。</b></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<h3 id="1-测试环境"><a href="#1-测试环境" class="headerlink" title="1. 测试环境"></a>1. 测试环境</h3><ul>
<li>MacBook Pro 15‘ i7 16GB</li>
<li>VMware Fushion 8 Pro</li>
<li>MySQL Version 5.6</li>
<li>CentOS Linux 6.x</li>
<li>slave Server ：172.16.102.129</li>
<li>local Server ：172.167.102.133</li>
</ul>
<h3 id="2-利用mysqldump导出sql文件"><a href="#2-利用mysqldump导出sql文件" class="headerlink" title="2. 利用mysqldump导出sql文件"></a>2. 利用mysqldump导出sql文件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是，mysqldump时会锁表，需要给mysqldump传递 <i>“–single-transaction”</i>  参数，可以使得mysqldump时不锁表，如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/mysqldump -h <span class="number">172.168</span><span class="number">.102</span><span class="number">.129</span> -u dbuser -pdbuser --single-transaction slave &gt; slave.sql</div></pre></td></tr></table></figure>
<h3 id="3-使用mysql恢复sql文件到数据库中"><a href="#3-使用mysql恢复sql文件到数据库中" class="headerlink" title="3. 使用mysql恢复sql文件到数据库中"></a>3. 使用mysql恢复sql文件到数据库中</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是，如果该local server的slave库中有数据表，当表名与slave server的表名相同时，数据表内的数据会被覆盖；如果local server的表在slave.sql中不存在，则不受影响，正是利用这个特性解决用户需求。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/usr/</span>bin<span class="regexp">/mysql -u dbuser -pdbuser report &lt; /</span>home<span class="regexp">/.mysql/</span>slave.sql</div></pre></td></tr></table></figure>
<h3 id="4-编写脚本"><a href="#4-编写脚本" class="headerlink" title="4. 编写脚本"></a>4. 编写脚本</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 首先在本地某一位置作为临时sql存储地址：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@report</span> ~]<span class="meta"># mkdir /home/.mysql     # 这个目录可以自定义</span></div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  脚本1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">TIME=`date <span class="string">"+%Y%m%d%H"</span>`</div><div class="line"></div><div class="line">rm -rf /home/.mysql/*</div><div class="line"></div><div class="line">/usr/bin/mysqldump -h 172.168.102.129 -u dbuser -pdbuser --single-transaction slave &gt; /home/.mysql/slave_<span class="variable">$TIME</span>.sql</div><div class="line"></div><div class="line">/usr/bin/mysql -u dbuser -pdbuser report &lt; /home/.mysql/slave_<span class="variable">$TIME</span>.sql</div></pre></td></tr></table></figure>
<h3 id="5-增加邮件通知功能"><a href="#5-增加邮件通知功能" class="headerlink" title="5. 增加邮件通知功能"></a>5. 增加邮件通知功能</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 因为前期同事需要得知备份的执行结果，所以希望数据同步成功后获得邮件提醒，这里使用sendmail实现，在CentOS里预装是没有安装sendmail，所以我们需要安装sendmail服务，另外一个安装命令行邮件工具mailx：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@report ~]# yum install -y sendmail mailx</div><div class="line"></div><div class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></div><div class="line"></div><div class="line">[root@report ~]#<span class="built_in"> service </span>sendmail start</div><div class="line">Starting sendmail:                                         [  OK  ]</div><div class="line">Starting sm-client:                                        [  OK  ]</div><div class="line">[root@report ~]# chkconfig sendmail on</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  完整脚本：report_sync.sh ，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">TIME=`date <span class="string">"+%Y%m%d%H"</span>`</div><div class="line"></div><div class="line">rm -rf /home/.mysql/*</div><div class="line"></div><div class="line">/usr/bin/mysqldump -h 172.168.102.129 -u dbuser -pdbuser --single-transaction slave &gt; /home/.mysql/slave_<span class="variable">$TIME</span>.sql</div><div class="line"></div><div class="line">/usr/bin/mysql -u dbuser -pdbuser report &lt; /home/.mysql/slave_<span class="variable">$TIME</span>.sql</div><div class="line"></div><div class="line"><span class="comment"># send mail to adminuser</span></div><div class="line"><span class="keyword">if</span> [ $? -eq 0 ]</div><div class="line"><span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"report SQL sync is successfully. At time: `date` "</span> | mail -s report-sync-successfully  hello@abc.cn</div><div class="line"><span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">" Error Error report SQL sync is Error. At time: `date` "</span> | mail -s report-sync-error  hello@abc.cn</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  查看下邮件通知：<br><img src="http://blog.ultraera.org:80/content/images/2016/03/24/p01.jpg" alt=""></p>
<h3 id="6-计划任务crontab"><a href="#6-计划任务crontab" class="headerlink" title="6. 计划任务crontab"></a>6. 计划任务crontab</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;和同事及客户沟通，确认每天1、5、9、13、17、21整时到从库拉去数据，Linux选择使用crontab做计划任务，crontab命令常见于Unix和类Unix的操作系统之中，用于设置周期性被执行的指令。该命令从标准输入设备读取指令，并将其存放于“crontab”文件中。通常，crontab储存的指令被守护进程激活， crond常常在后台运行，每一分钟检查是否有预定的作业需要执行。这类作业一般称为cron jobs。</p>
<h4 id="6-1-安装crontab"><a href="#6-1-安装crontab" class="headerlink" title="6.1 安装crontab"></a>6.1 安装crontab</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@report ~]# yum install -y vixie-cron</div><div class="line">[root@report ~]# yum install -y crontabs</div><div class="line"></div><div class="line">说明：</div><div class="line">vixie-cron软件包是cron的主程序；</div><div class="line">crontabs软件包是用来安装、卸装、或列举用来驱动 crond 守护进程的表格的程序。</div><div class="line"></div><div class="line">cron 是linux的内置服务，但它不自动起来，可以用以下的方法启动、关闭这个服务：</div><div class="line">/sbin<span class="built_in">/service </span>crond start #启动服务</div><div class="line">/sbin<span class="built_in">/service </span>crond stop #关闭服务</div><div class="line">/sbin<span class="built_in">/service </span>crond restart #重启服务</div><div class="line">/sbin<span class="built_in">/service </span>crond reload #重新载入配置</div><div class="line"></div><div class="line">设置crond开机自启动</div><div class="line">[root@report ~]# chkconfig crond on</div></pre></td></tr></table></figure>
<h3 id="7-添加计划任务"><a href="#7-添加计划任务" class="headerlink" title="7. 添加计划任务"></a>7. 添加计划任务</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将脚本report_sync.sh 保存到/usr/bin下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root<span class="symbol">@report</span> ~]<span class="meta"># mv report_sync.sh /usr/bin</span></div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;增加计划任务：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@report ~]# crontab -e</div><div class="line"></div><div class="line"># add this word.</div><div class="line">* <span class="number">1</span><span class="number">-21</span>/<span class="number">4</span>  * * * /usr/bin/report_sync.sh</div><div class="line"></div><div class="line"># 表示在每天的<span class="number">1</span><span class="number">-21</span>时间内，每<span class="number">4</span>小时执行一个脚本</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/03/24/how-set-sftp-on-centos/" class="prev">PREV</a><a href="/2016/03/23/linux-bi-shi-shi-ti/" class="next">NEXT</a></div><div class="copyright"><p>© 2012 - 2017 <a href="https://samzong.me">SAMZONG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>