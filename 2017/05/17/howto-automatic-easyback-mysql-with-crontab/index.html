<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HowTo-Automatic-EasyBackup-MysqlDB · SAMZONG</title><meta name="description" content="HowTo-Automatic-EasyBackup-MysqlDB - SAMZONG"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://samzong.me/atom.xml" title="SAMZONG"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HowTo-Automatic-EasyBackup-MysqlDB</h1><div class="post-info">May 17, 2017</div><div class="post-content"><p>mysql是一个免费、开源中一款非常优秀关系型数据库，在现在的互联网中使用的非常广泛，无论是大型IT项目还是个人开发者的小项目，mysql都能很好的协助人们处理数据库相关的工作，同时数据库对于我们来说是非常重要，所以经常备份数据库是一个基本的操作，这会为你或者你的团队，减少非常多不必要的麻烦。</p>
<p><code>mysqldump</code>是一个简单而且非常流行的mysql全量备份方式，配合<code>crontab</code>添加自动备份任务，很好的完成了我们针对数据库备份的需求，下面我会通过一个例子来说明如何完成这项操作。</p>
<blockquote>
<p>mysqldump是mysql自带的备份工具，所以只要你安装mysql应用包，就无需单独安装mysqldump</p>
</blockquote>
<h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><p>我搭建了一个Ghost博客环境，数据库采用是的Mysql，接下来我想在每天00:00执行数据库备份操作，并在备份完成之后，告诉我是否备份成功。</p>
<p><img src="http://ww1.sinaimg.cn/large/006tKfTcgy1ffogclgk9dj30f00cq3zf.jpg" alt=""></p>
<p>所以我们的步骤应该：</p>
<ol>
<li>测试备份命令是否可以正常执行</li>
<li>安装测试命令行邮件工具mailx</li>
<li>安装计划任务工具Crontab</li>
<li>编写备份脚本</li>
<li>添加计划任务</li>
</ol>
<h4 id="测试备份命令"><a href="#测试备份命令" class="headerlink" title="测试备份命令"></a>测试备份命令</h4><p>首先你要获得你要备份的数据库对应的select权限，仅需要select权限即可，mysql在管理方面，应该坚持只赋予必须权限的原则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; grant select on ghost.* to &apos;ghost_backuser&apos;@&apos;localhost&apos; identified by &apos;backupPass&apos;;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>因为我只在本地执行备份操作，所以我只赋予了<code>localhost</code>的权限，你的权限应该要是执行备份工作的服务器主机信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 创建仅授权本地访问的用户</div><div class="line">mysql&gt; create user dbackuser@&apos;localhost&apos;;</div><div class="line"># 创建授权所有来源地址的用户</div><div class="line">mysql&gt; create user dbackuser@&apos;%&apos;;</div><div class="line"># 创建仅授权从特定IP的用户</div><div class="line">mysql&gt; create user dbackuser@&apos;192.168.0.230&apos;;</div><div class="line"># 创建仅授权从特定IP段访问的用户</div><div class="line">mysql&gt; create user dbackuser@&apos;192.168.0.0/23&apos;;</div><div class="line"># 创建仅授权从特定域名来访问的用户</div><div class="line">mysql&gt; create user dbackuser@&apos;samzong.me&apos;;</div></pre></td></tr></table></figure>
<p>好了，接下来我们测试对应用户是否有权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">➜  ~ mysql -u ghost_backuser -pbackupPass</div><div class="line">Warning: Using a password on the command line interface can be insecure.</div><div class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</div><div class="line">Your MySQL connection id is 7</div><div class="line">Server version: 5.6.35 MySQL Community Server (GPL)</div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</div><div class="line"></div><div class="line">Oracle is a registered trademark of Oracle Corporation and/or its</div><div class="line">affiliates. Other names may be trademarks of their respective</div><div class="line">owners.</div><div class="line"></div><div class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</div><div class="line"></div><div class="line">mysql&gt; show databases;</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| ghost              |</div><div class="line">+--------------------+</div><div class="line">2 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; use ghost;</div><div class="line">Reading table information for completion of table and column names</div><div class="line">You can turn off this feature to get a quicker startup with -A</div><div class="line"></div><div class="line">Database changed</div><div class="line"></div><div class="line">mysql&gt; select name from users;</div><div class="line">+------+</div><div class="line">| name |</div><div class="line">+------+</div><div class="line">| ALEX |</div><div class="line">+------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>测试<code>mysqldump</code>备份命令，注意mysqldump备份会锁表，但对于正在工作的数据库，锁表会影响到正常业务，所以我们可以使用<code>–single-transaction</code>参数，不锁表备份。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">➜  ~ mysqldump -u ghost_backuser -pbackupPass ghost &gt; ghost.bak.sql</div><div class="line">Warning: Using a password on the command line interface can be insecure.</div><div class="line">mysqldump: Got error: 1044: Access denied for user 'ghost_backuser'@'localhost' to database 'ghost' when using LOCK TABLES</div><div class="line">➜  ~ mysqldump -u ghost_backuser -pbackupPass --single-transaction ghost &gt; ghost.bak.sql</div><div class="line">Warning: Using a password on the command line interface can be insecure.</div><div class="line">➜  ~ ls -lh</div><div class="line">total 780K</div><div class="line">-rw-r--r-- 1 root   root  780K May 17 16:24 ghost.bak.sql</div><div class="line">➜  ~</div></pre></td></tr></table></figure>
<h4 id="安装命令行邮件工具mailx"><a href="#安装命令行邮件工具mailx" class="headerlink" title="安装命令行邮件工具mailx"></a>安装命令行邮件工具mailx</h4><p>安装mailx 在CentOS/RehHat:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">➜  ~ yum install -y mailx</div></pre></td></tr></table></figure>
<p>测试发送邮件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">➜  ~ echo "test" | mail -s "this a test email" samzong.lu@gmail.com</div></pre></td></tr></table></figure>
<p><img src="http://ww2.sinaimg.cn/large/006tKfTcgy1ffogc7wksdj30ms03t3ym.jpg" alt=""></p>
<h4 id="安装计划任务工具Crontab"><a href="#安装计划任务工具Crontab" class="headerlink" title="安装计划任务工具Crontab"></a>安装计划任务工具Crontab</h4><p>crontab命令常见于Unix和类Unix的操作系统之中，用于设置周期性被执行的指令。该命令从标准输入设备读取指令，并将其存放于“crontab”文件中。通常，crontab储存的指令被守护进程激活， crond常常在后台运行，每一分钟检查是否有预定的作业需要执行。这类作业一般称为cron jobs。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  ~ yum install vixie-cron</div><div class="line">➜  ~ yum install crontabs</div></pre></td></tr></table></figure>
<blockquote>
<p>vixie-cron软件包是cron的主程序；</p>
<p>crontabs软件包是用来安装、卸装、或列举用来驱动 cron 守护进程的表格的程序。</p>
</blockquote>
<p>启动crond并设置为开机自启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">➜  ~ service crond start</div><div class="line">Starting crond:                                            [  OK  ]</div><div class="line">➜  ~ chkconfig crond on</div></pre></td></tr></table></figure>
<p>crontab 基础命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">语　　法：crontab [-u &lt;用户名称&gt;][配置文件] 或 crontab [-u &lt;用户名称&gt;][-elr]</div><div class="line"></div><div class="line">补充说明：cron是一个常驻服务，它提供计时器的功能，让用户在特定的时间得以执行预设的指令或程序。只要用户会编辑计时器的配置文件，就可以使用计时器的功能。</div><div class="line"></div><div class="line">配置文件格式：Minute Hour Day Month DayOFWeek Command</div><div class="line"></div><div class="line">参　　数：</div><div class="line">-e 　编辑该用户的计时器设置。</div><div class="line">-l 　列出该用户的计时器设置。</div><div class="line">-r 　删除该用户的计时器设置。</div><div class="line">-u&lt;用户名称&gt; 　指定要设定计时器的用户名称。</div></pre></td></tr></table></figure>
<p>crontab 配置的基本格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">*     * 　 *　  *　  *　　<span class="built_in">command</span></div><div class="line">分　  时　 日　 月　 周　  命令</div><div class="line"></div><div class="line"> 第1列表示分钟1～59 每分钟用*或者 */1表示</div><div class="line"> 第2列表示小时1～23（0表示0点）</div><div class="line"> 第3列表示日期1～31</div><div class="line"> 第4列表示月份1～12</div><div class="line"> 第5列标识号星期0～6（0表示星期天）</div><div class="line"> 第6列要运行的命令</div></pre></td></tr></table></figure>
<p>crontab 的一些例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#每晚的21:30 重启apache</span></div><div class="line">30 21 * * * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每月1、10、22日的4 : 45重启apache</span></div><div class="line">45 4 1,10,22 * * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每周六、周日的1 : 10重启apache</span></div><div class="line">10 1 * * 6,0 /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每天18 : 00至23 : 00之间每隔30分钟重启apache</span></div><div class="line">0,30 18-23 * * * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每星期六的11 : 00 pm重启apache</span></div><div class="line">0 23 * * 6 /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#晚上11点到早上7点之间，每隔一小时重启apache</span></div><div class="line">* 23-7/1 * * * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每一小时重启apache</span></div><div class="line">* */1 * * * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每月的4号与每周一到周三的11点重启apache</span></div><div class="line">0 11 4 * mon-wed /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#一月一号的4点重启apache</span></div><div class="line">0 4 1 jan * /usr/<span class="built_in">local</span>/etc/rc.d/lighttpd restart</div><div class="line"></div><div class="line"><span class="comment">#每半小时同步一下时间</span></div><div class="line">*/30 * * * * /usr/sbin/ntpdate 210.72.145.44</div></pre></td></tr></table></figure>
<h4 id="编写备份脚本"><a href="#编写备份脚本" class="headerlink" title="编写备份脚本"></a>编写备份脚本</h4><p>好了，以上我们测试需要用到的各个模块，下面我们要编写备份脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></div><div class="line"><span class="meta">#</span><span class="bash">  mysqldump scripts.</span></div><div class="line"><span class="meta">#</span><span class="bash"> filepath: /usr/<span class="built_in">local</span>/bin/ghost_sqldump.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> Author: samzong</span></div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash">  <span class="built_in">set</span> TIME variable</span></div><div class="line">TIME=`date "+%Y%m%d%H%M%S"`</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> backup db ghost to /mysqlbak/</span></div><div class="line">mysqldump --single-transaction -h localhost -u ghost_backuser -pbackupPass ghost  &gt; /mysqlbak/ghost_$TIME.sql</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> tar sql files.</span></div><div class="line">tar czvf /mysqlbak/ghost_$TIME.sql.tgz /mysqlbak/ghost_$TIME.sql --remove-files</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> remove over 7 days sql files.</span></div><div class="line">find /mysqlbak/ -mtime +7 -exec rm -f &#123;&#125; \;</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"> send mial to admin<span class="string">'mial</span></span></div><div class="line">if [ $? -eq 0 ]</div><div class="line">then</div><div class="line">	echo "ghost SQL dump is successfully. At time: `date` " | mail -s ghost-dump-successfully  samzong.lu@gmail.com</div><div class="line">else</div><div class="line">	echo " Error Error ghost SQL dump is Error. At time: `date` " | mail -s ghost-dump-error samzong.lu@gmail.com</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>注意脚本中的以下内容要根据你的实际情况修改:</p>
<ul>
<li>-h “ “     这是数据库所在的主机</li>
<li>-u “ “       这是数据库可备份的用户名</li>
<li>-p” “        备份用户的密码</li>
</ul>
<h4 id="添加计划任务"><a href="#添加计划任务" class="headerlink" title="添加计划任务"></a>添加计划任务</h4><p>经过以上测试，已经很好的完成备份脚本，接下来将脚本添加到crontab内，并设置自动执行的时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">➜  ~ crontab -e</div><div class="line">00 00 * * * sh /usr/<span class="built_in">local</span>/bin/ghost_sqldump.sh</div></pre></td></tr></table></figure>
<p>重启crontab服务，并确认crontab已经设置为开机自启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">➜  ~ service crond restart</div><div class="line">Stopping crond:                                            [  OK  ]</div><div class="line">Starting crond:                                            [  OK  ]</div><div class="line">➜  ~ chkconfig --list | grep crond</div><div class="line">crond          	0:off	1:off	2:on	3:on	4:on	5:on	6:off</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2017/05/19/tortoisegit-for-windows/" class="prev">PREV</a><a href="/2017/05/13/fix-Wannacry/" class="next">NEXT</a></div><div class="copyright"><p>© 2012 - 2017 <a href="https://samzong.me">SAMZONG</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>